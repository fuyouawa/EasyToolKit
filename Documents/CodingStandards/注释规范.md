# 注释规范

## 注释语言原则

### 框架代码与业务代码区分

**框架代码** - **必须使用英文注释**
- 原因：框架代码面向广泛的开发者群体，英文注释确保最大可读性和专业性
- 所有公共 API、类、方法、属性都必须有完整的英文 XML 文档注释

**业务代码** - **推荐使用英文，允许使用中文**
- 业务代码指：使用框架开发的具体游戏功能、业务逻辑
- 英文注释不好时，可以使用中文注释，但应保持清晰和专业
- 建议逐步提升英文注释能力

### 注释语言使用示例

```csharp
// 框架代码 - 必须使用英文注释
namespace EasyToolkit.Core
{
    /// <summary>
    /// Provides event management functionality with type-safe event handling.
    /// </summary>
    public class EasyEventManager
    {
        /// <summary>
        /// Subscribes to an event with the specified handler.
        /// </summary>
        /// <typeparam name="TEvent">The event type.</typeparam>
        /// <param name="handler">The event handler.</param>
        public void Subscribe<TEvent>(Action<TEvent> handler) { }
    }
}

// 业务代码 - 允许中文注释
namespace Game.Features.Player
{
    /// <summary>
    /// 管理玩家的生命值系统
    /// </summary>
    public class PlayerHealth
    {
        /// <summary>
        /// 对玩家造成伤害
        /// </summary>
        /// <param name="damage">伤害值</param>
        public void TakeDamage(int damage) { }
    }
}
```

---

## XML 文档注释

### 使用场景

- 所有公共类型（类、结构、枚举、接口）
- 所有公共成员（方法、属性、事件、字段）
- 重要的保护成员
- 复杂的私有成员（如果实现不直观）

### 基本格式

```csharp
/// <summary>
/// Brief description of what the class/method does.
/// </summary>
/// <param name="paramName">Description of parameter.</param>
/// <returns>Description of return value.</returns>
/// <remarks>
/// Additional information about usage, behavior, or implementation details.
/// </remarks>
/// <exception cref="ExceptionType">Description of when this exception is thrown.</exception>
```

### 完整示例

```csharp
/// <summary>
/// Manages player state including health, mana, and combat status.
/// Provides methods for taking damage, healing, and checking death status.
/// </summary>
/// <remarks>
/// This class is not thread-safe. Use external synchronization when accessing
/// from multiple threads.
/// </remarks>
public class PlayerState
{
    /// <summary>
    /// Gets the current health points.
    /// </summary>
    /// <value>
    /// The current health, ranging from 0 to <see cref="MaxHealth"/>.
    /// </value>
    public int Health { get; private set; }

    /// <summary>
    /// Applies damage to the player and triggers death if health reaches zero.
    /// </summary>
    /// <param name="damage">The amount of damage to apply. Must be non-negative.</param>
    /// <param name="damageType">The type of damage (physical, magical, true damage).</param>
    /// <returns>
    /// The actual damage applied after mitigation. Returns 0 if the player is already dead.
    /// </returns>
    /// <exception cref="ArgumentOutOfRangeException">
    /// Thrown when <paramref name="damage"/> is negative.
    /// </exception>
    /// <remarks>
    /// This method invokes the <see cref="DamageTaken"/> event even if damage is zero
    /// but the player is not dead.
    /// </remarks>
    public int TakeDamage(int damage, DamageType damageType)
    {
        if (damage < 0)
            throw new ArgumentOutOfRangeException(nameof(damage), "Damage cannot be negative.");

        // Implementation...
    }

    /// <summary>
    /// Raised when the player takes damage.
    /// </summary>
    /// <remarks>
    /// The event is raised before damage mitigation is applied.
    /// </remarks>
    public event Action<DamageEventArgs> DamageTaken;
}
```

---

## 类型引用注释

### 使用 `<see cref=""/>` 引用其他类型

```csharp
/// <summary>
/// Converts a <see cref="List{T}"/> to a read-only <see cref="IEnumerable{T}"/>.
/// </summary>
/// <seealso cref="ArrayConverter"/>
/// <seealso cref="System.Linq.Enumerable"/>
public IEnumerable<T> ToReadOnly<T>(List<T> source)
{
    // Implementation
}
```

---

## XML 特殊字符转义

在 XML 文档注释中，`<` 和 `>` 是 XML 标签的特殊字符。当注释中需要显示这些字符（例如泛型类型如 `List<int>` 或比较运算符）时，必须进行转义：

- `<` → `&lt;`
- `>` → `&gt;`

### 转义示例

```csharp
/// <summary>
/// Compares two values and returns true if left &lt; right.
/// </summary>
/// <param name="left">The left operand.</param>
/// <param name="right">The right operand.</param>
/// <returns>True if left &lt; right, otherwise false.</returns>
public bool IsLessThan(int left, int right)
{
    return left < right;
}
```

### 常见转义场景

| 原始内容 | 转义后 | 使用场景 |
|---------|--------|---------|
| `<T>` | `&lt;T&gt;` | 泛型类型参数 |
| `List<int>` | `List&lt;int&gt;` | 具体泛型类型 |
| `a < b` | `a &lt; b` | 小于比较 |
| `x > 0` | `x &gt; 0` | 大于比较 |
| `<see cref="List<T>"/>` | `&lt;see cref="List&lt;T&gt;"/&gt;` | see 标签中的泛型 |

---

## 类注释

### 类注释规范

1. **说明类的职责和用途**
2. **描述类的关键行为**
3. **说明线程安全性**
4. **提供使用示例**（对于复杂类）

### 示例

```csharp
/// <summary>
/// Thread-safe singleton event manager for application-wide event handling.
/// Provides type-safe event subscription and publication with automatic memory management.
/// </summary>
/// <remarks>
/// <para>
/// This class uses a weak reference system to prevent memory leaks when subscribers
/// fail to unsubscribe. Events are dispatched on the thread they are published.
/// </para>
/// <para>
/// Usage example:
/// <code>
/// manager.Subscribe<PlayerSpawnedEvent>(OnPlayerSpawned);
/// manager.Publish(new PlayerSpawnedEvent(playerId));
/// </code>
/// </para>
/// </remarks>
public class EasyEventManager
{
}
```

---

## 函数注释

### 基本原则

1. **注释描述函数做什么，而不是命令函数做什么**
   - 注释是对函数行为的**描述性说明**，而非指令性命令
   - 应使用陈述语气说明函数的功能、用途和行为
   - 避免使用"必须"、"应该"、"需要"等命令式语言

2. **注释通常不描述函数如何工作**
   - 函数的实现细节属于函数定义本身
   - 注释应关注"**是什么**"和"**为什么**"，而非"**怎么做**"
   - 实现细节仅在必要时作为补充说明

### 公共函数

**必须包含的内容**：

1. `<summary>` - 函数功能描述
2. `<param>` - 所有参数说明
3. `<returns>` - 返回值说明（非 void 方法）
4. `<remarks>` - 额外说明（如需要）
5. `<exception>` - 仅标识用户需要关注的异常（见下文）

### 异常注释规范

**基本规则**：仅标识用户在正常使用中需要关注的异常，不记录开发期防御性检查。

#### 需要标识

```csharp
/// <exception cref="InsufficientFundsException">
/// Thrown when balance is less than transfer amount.
/// </exception>
/// <exception cref="ServerUnavailableException">
/// Thrown when server is not responding.
/// </exception>
/// <exception cref="InvalidOperationException">
/// Thrown when session is already started.
/// </exception>
```

#### 不需要标识

```csharp
// 参数 null 检查
if (eventHandler == null)
    throw new ArgumentNullException(nameof(eventHandler));

// 参数范围验证
if (level < 0 || level > MaxLevel)
    throw new ArgumentOutOfRangeException(nameof(level));

// 类型检查
if (!(component is IComponent))
    throw new ArgumentException("Must be IComponent", nameof(component));
```

**判断标准**：该异常是否在正常使用场景下用户可能遇到并需要处理？

### 私有函数

**简单私有函数** - 如果函数名和参数已经足够清晰，无需注释

```csharp
// No comment needed - the name is self-explanatory
private void ResetHealth()
{
    _health = MaxHealth;
}
```

**复杂私有函数** - 添加注释说明逻辑

```csharp
/// <summary>
/// Calculates the damage mitigation based on armor and resistance.
/// Uses a diminishing returns formula: Mitigation = Armor / (Armor + 100).
/// </summary>
private float CalculateDamageMitigation(float armor, float resistance)
{
}
```

---

## 变量注释

### 公共字段/属性

**使用 `<summary>` 注释**

```csharp
/// <summary>
/// Gets the maximum number of players supported by this server instance.
/// </summary>
public int MaxPlayers { get; }
```

### 私有字段

**需要注释的情况**：
1. 字段名不能完全表达其用途
2. 字段有特定的取值范围或约束
3. 字段之间有依赖关系

**注释方式**：使用行尾注释（`//`）

```csharp
// Cache of previously computed results to avoid redundant calculations
private readonly Dictionary<string, object> _cache;

// Interval in seconds between auto-save operations. Must be > 0.
private float _autoSaveInterval;

// Flag indicating whether player is in god mode (for testing)
private bool _isGodMode;
```

**无需注释的情况**：

```csharp
private string _playerName;      // Clear from name
private int _health;             // Clear from name
private List<Item> _inventory;   // Clear from name
```

---

## 实现注释

### 代码块注释

**使用场景**：解释复杂的算法逻辑、业务规则

**注释位置**：在代码块之前，使用 `//` 或 `/* */`

**示例**：

```csharp
public void ProcessTurn()
{
    // Phase 1: Calculate initiative for all combatants
    // Initiative = (Dexterity / 2) + Random(1-20)
    foreach (var combatant in _combatants)
    {
        combatant.Initiative = combatant.Dexterity / 2.0f + Random.Range(1, 20);
    }

    // Phase 2: Sort combatants by initiative (descending)
    // Higher initiative acts first
    _combatants.Sort((a, b) => b.Initiative.CompareTo(a.Initiative));

    // Phase 3: Execute turns in initiative order
    // Skip dead combatants and those with skipped turn status
    foreach (var combatant in _combatants)
    {
        if (combatant.IsDead || combatant.SkipTurn)
            continue;

        ExecuteCombatantTurn(combatant);
    }
}
```

### 行内注释

**使用场景**：解释特定行的逻辑，通常用于说明"为什么"而非"是什么"

**示例**：

```csharp
// Use StringComparer.Ordinal for case-sensitive comparison (security requirement)
var isValid = _userNames.Contains(userName, StringComparer.Ordinal);

// Defer event invocation to avoid deadlock during UI updates
UnityMainThreadDispatcher.Instance.Enqueue(() => OnDataLoaded?.Invoke(data));

// Clone the list to prevent modification during enumeration
var itemsCopy = _items.ToList();
foreach (var item in itemsCopy)
{
    ProcessItem(item);
}
```

---

## 特殊注释标记

### TODO 注释

**格式**：`TODO(username): Description`

**用途**：标记待完成的功能或已知的临时解决方案

**示例**：

```csharp
// TODO(john): Implement proper error handling for network timeouts
public void ConnectToServer()
{
    // Temporary: Infinite retry
    while (!Connect()) { }
}

// TODO(jane): Refactor this method to use async/await pattern
public void LoadData()
{
}
```

### FIXME 注释

**格式**：`FIXME(username): Description`

**用途**：标记需要修复的已知问题或 Bug

**示例**：

```csharp
// FIXME(bob): This doesn't handle negative values correctly
public int CalculateScore(int baseValue)
{
    return baseValue * _multiplier; // Bug: Should clamp to minimum of 0
}
```

### HACK 注释

**格式**：`HACK(username): Reason`

**用途**：标记使用了不优雅或不规范的解决方案，应告知原因

**示例**：

```csharp
// HACK(alice): Using reflection to access private field because the API doesn't expose it
// This should be removed when framework adds public accessors
var field = typeof(PlayerData).GetField("_internalState", BindingFlags.NonPublic | BindingFlags.Instance);
var state = field.GetValue(playerData);
```

### NOTE 注释

**格式**：`NOTE: Description`

**用途**：强调重要的实现细节或注意事项

**示例**：

```csharp
// NOTE: This method must be called on the main thread
// Calling from background threads will cause undefined behavior
public void UpdateUI()
{
}

// NOTE: The order of operations matters here
// We must validate before applying changes
ValidateInput();
ApplyChanges();
```

### DEPRECATED 注释

**格式**：使用 `[Obsolete]` 特性 + XML 注释

**用途**：标记过时的 API，提供替代方案

**示例**：

```csharp
/// <summary>
/// Gets the player's current health.
/// </summary>
/// <remarks>
/// This property is deprecated. Use <see cref="HealthPoints"/> instead.
/// </remarks>
[Obsolete("Use HealthPoints property instead.")]
public int Health
{
    get => _health;
}
```

---

## 注释最佳实践

### 应该做的

1. **解释"为什么"而非"是什么"**
   ```csharp
   // Good: Explains why
   // Use a HashSet for O(1) lookups instead of List's O(n)
   private readonly HashSet<string> _cachedItems;

   // Bad: Just repeats what the code says
   // Create a HashSet
   private readonly HashSet<string> _cachedItems;
   ```

2. **保持注释与代码同步**
   - 修改代码时，同时更新相关注释
   - 过时的注释比没有注释更糟糕

3. **使用清晰的语法和拼写**
   - 注释是代码文档的一部分
   - 使用完整的句子，正确的标点符号

4. **为关键决策提供注释**
   ```csharp
   // Chose LinkedList over List because we need frequent insertions at the beginning
   private readonly LinkedList<Action> _actionQueue;
   ```

### 不应该做的

1. **避免注释显而易见的代码**
   ```csharp
   // Bad: This adds no value
   i++; // Increment i

   // Good: No comment needed
   i++;
   ```

2. **避免使用注释掩盖代码问题**
   ```csharp
   // Bad: Comment instead of fixing
   // TODO: This is wrong but it works
   var result = DoSomethingWrong();

   // Good: Fix the problem or document why it can't be fixed
   // HACK: Using workaround because upstream library has bug #123
   var result = WorkaroundForLibraryBug();
   ```

3. **避免过长的注释**
   - 如果注释比代码还长，考虑重命名或重构代码
   - 复杂逻辑的注释应保持在合理长度

4. **避免使用非标准缩写**
   ```csharp
   // Bad: Unclear abbreviations
   // Calc val bef rtrn

   // Good: Clear language
   // Calculate value before return
   ```

---
