# 日志和错误信息规范

## 日志级别定义

**日志级别使用原则**：

### Debug - 调试信息
- 用于开发阶段排查问题
- 包含详细的方法调用、参数值、中间状态
- 生产环境通常关闭

### Info - 常规信息
- 记录系统正常运行状态
- 重要的业务操作、状态变更
- 用户登录、关键数据更新等

### Warning - 警告信息
- 表示潜在问题但系统仍可运行
- 非关键错误、降级处理、配置问题
- 资源不足、性能警告等

### Error - 错误信息
- 表示功能失败但系统可继续运行
- 业务逻辑错误、外部服务调用失败
- 数据验证失败、权限不足等

### Fatal - 致命错误
- 系统无法继续运行
- 关键组件初始化失败、内存耗尽
- 数据库连接失败等

---

## 日志消息格式规范

**基本格式**：`[Context] Action: Description (Details)`

**组件说明**：
- **Context**：日志发生的上下文（类名、模块名）
- **Action**：执行的操作或事件
- **Description**：操作结果或状态描述
- **Details**：相关参数、错误信息等详细信息

**示例**：

```csharp
// Debug 级别
Debug.Log($"[Player] PlayerLogin: Player {playerId} logged in (Name: {playerName})");

// Info 级别
Logger.Info($"[Player] PlayerJoined: Player {playerId} joined the game (Position: {position})");

// Warning 级别
Logger.Warning($"[Resource] AssetLoadFailed: Failed to load asset {assetPath} (Reason: {error.Message})");

// Error 级别
Logger.Error($"[Network] ConnectionLost: Lost connection to server {serverAddress} (Error: {exception.Message})");
```

---

## 错误信息语法规范

**错误消息结构**：`What happened? Why it happened? How to fix?`

**组件说明**：
- **What**：发生了什么错误
- **Why**：错误的原因（如果知道）
- **How**：如何解决或下一步操作

**示例**：

```csharp
// 验证错误
throw new ArgumentException("Player name cannot be empty. Name validation failed. Please provide a valid player name.");

// 业务逻辑错误
throw new InvalidOperationException("Cannot attack while dead. Player health is 0. Revive player before attacking.");

// 资源错误
throw new FileNotFoundException("Asset file not found. File path is invalid or file does not exist. Check the asset path and ensure the file exists.");
```

---

## 异常处理规范

### 异常捕获原则

1. **只捕获你能处理的异常**
2. **使用具体的异常类型**，避免捕获通用 Exception
3. **记录异常上下文信息**
4. **重新抛出时保留原始异常**

### 异常处理示例

```csharp
public void LoadPlayerData(int playerId)
{
    try
    {
        var data = _dataService.GetPlayerData(playerId);
        // 处理数据
    }
    catch (DataServiceException ex)
    {
        // 记录详细的错误信息
        Logger.Error($"[PlayerService] LoadPlayerDataFailed: Failed to load player data for {playerId} " +
                     $"(Error: {ex.Message}, Inner: {ex.InnerException?.Message})");

        // 抛出业务异常，保留原始异常
        throw new PlayerDataLoadException($"Failed to load player data for {playerId}", ex);
    }
    catch (TimeoutException ex)
    {
        // 处理超时异常
        Logger.Warning($"[PlayerService] LoadPlayerDataTimeout: Timeout loading player data for {playerId}");
        throw;
    }
}
```

---

## 自定义异常规范

### 命名规则
`XxxException`

### 构造函数要求
- 提供有意义的错误消息
- 支持传递内部异常
- 可选的错误代码或上下文数据

### 自定义异常示例

```csharp
public class PlayerNotFoundException : Exception
{
    public int PlayerId { get; }

    public PlayerNotFoundException(int playerId)
        : base($"Player with ID {playerId} was not found. The player may not exist or has been deleted.")
    {
        PlayerId = playerId;
    }

    public PlayerNotFoundException(int playerId, Exception innerException)
        : base($"Player with ID {playerId} was not found. The player may not exist or has been deleted.", innerException)
    {
        PlayerId = playerId;
    }
}

public class InsufficientResourceException : Exception
{
    public string ResourceType { get; }
    public int Required { get; }
    public int Available { get; }

    public InsufficientResourceException(string resourceType, int required, int available)
        : base($"Insufficient {resourceType}. Required: {required}, Available: {available}. " +
               $"Please acquire more {resourceType} or reduce the requirement.")
    {
        ResourceType = resourceType;
        Required = required;
        Available = available;
    }
}
```

---

## 异常处理最佳实践

### 应该做的

1. **使用具体的异常类型**
   ```csharp
   // Good: 捕获具体异常
   catch (FileNotFoundException ex)
   {
       Logger.Error($"File not found: {filePath}");
   }
   ```

2. **记录异常上下文信息**
   ```csharp
   catch (Exception ex)
   {
       Logger.Error($"[Service] Operation failed for user {userId} (Action: {actionName})", ex);
   }
   ```

3. **重新抛出时保留原始异常**
   ```csharp
   catch (IOException ex)
   {
       throw new ServiceException("Failed to load data", ex);
   }
   ```

### 不应该做的

1. **捕获所有异常**
   ```csharp
   // Bad: 捕获所有异常会掩盖问题
   catch (Exception ex)
   {
       // 吞噬所有异常
   }
   ```

2. **不记录就重新抛出**
   ```csharp
   // Bad: 重新抛出但未记录任何信息
   catch
   {
       throw;
   }
   ```

3. **空的 catch 块**
   ```csharp
   // Bad: 空的 catch 块
   catch (Exception)
   {
       // 什么都不做
   }
   ```

---
